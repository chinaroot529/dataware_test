# 学霸神器数仓 - 权限系统使用指南

## 📋 系统概述

我们成功建立了一个完整的权限控制系统，支持"学霸神器数仓"项目的复杂教育场景需求。

### 🎯 核心设计理念

1. **"默认开放，按需限制"** - 题目创建后默认学段共享，特殊需求可限制路径
2. **"副本机制"** - 无编辑权自动创建副本，有编辑权可选择更新原题或创建副本  
3. **"路径权限"** - 支持学校→学部→年级→班级的精准权限控制
4. **"权限叠加"** - 个人权限 + 组织权限 + 学段权限的图数据库式展开

## 🗄️ 数据库信息

- **服务器地址**: 10.10.0.117:6033
- **数据库名**: data_ware_test
- **用户名**: root
- **密码**: Xml123&45!

## 📊 数据模型结构

### 核心表结构（10张表）

1. **组织树维度** - 支持4级层次结构（学校→学部→年级→班级）
2. **角色定义表** - 9种角色类型（系统管理员、校长、学部主任等）
3. **个人维度** - 完整用户信息管理
4. **权限定义表** - 14种权限类型（查看、编辑、删除、分享等）
5. **用户组织关系表** - 支持多组织、临时权限、跨班级任课
6. **角色权限桥接表** - 角色权限映射关系
7. **题目操作ACL表** - 资源级别权限控制
8. **权限申请表** - 权限申请审批流程
9. **操作审计表** - 操作日志审计
10. **权限变更日志表** - 权限变更历史记录

### 示例数据概览

- **组织结构**: 14个组织（博雅中学完整架构）
- **用户数据**: 12个用户（管理员、教师、学生）
- **角色权限**: 32个角色权限关系
- **ACL记录**: 5个示例权限控制
- **审计日志**: 完整操作记录

## 🚀 快速开始

### 1. 环境准备

```bash
# 安装依赖
pip install pymysql==1.1.0

# 验证连接
python -c "import pymysql; print('依赖安装成功')"
```

### 2. 脚本使用

我们提供了3个核心脚本：

```bash
# 建表脚本 - 创建完整表结构
python create_permission_system.py

# 数据插入脚本 - 插入示例数据
python insert_sample_data.py

# 功能验证脚本 - 测试系统功能
python test_permission_system.py
```

## 🔍 功能验证结果

✅ **所有核心功能正常工作**:

1. **用户权限展开机制** - 孙老师跨班级任课14项权限正确展开
2. **题目访问权限控制** - Q001、Q002题目权限验证通过
3. **跨班级任课支持** - 主要班级+兼任班级权限叠加
4. **临时权限管理** - 代课教师90天临时权限
5. **权限申请流程** - 跨班级资源申请待审批
6. **组织权限继承** - 4级组织层次权限正确继承
7. **权限使用统计** - 14种权限分配给不同角色
8. **操作审计日志** - 完整操作记录追踪

## 📈 关键场景验证

### 场景1：跨班级任课教师（孙老师）
- **主要班级**: 高一二班（1000/1100/1110/1112）
- **兼任班级**: 高二三班（1000/1100/1120/1123）  
- **权限范围**: 7项基础教师权限 × 2个班级 = 14项权限
- **访问资源**: Q001（高中部共享）+ Q002（班级专享）

### 场景2：临时代课教师（吴老师）
- **权限类型**: 临时权限
- **权限范围**: 高二一班（1000/1100/1120/1121）
- **有效期**: 90天（2025-10-06到期）
- **角色权限**: 代课教师基础权限

### 场景3：权限申请流程
- **申请事项**: 孙老师申请Q002的查看权限
- **申请状态**: 待审批
- **权限来源**: 申请获得
- **审批流程**: 资源所有者（陈老师）审批

## 🛡️ 安全机制

### 1. 权限控制层级
- **个人层级**: 直接授权给特定用户
- **组织层级**: 基于组织路径的权限继承
- **角色层级**: 基于角色的权限分配

### 2. 审计追踪
- **操作审计**: 记录所有重要操作
- **权限变更**: 追踪权限变更历史
- **IP追踪**: 记录操作来源IP

### 3. 时效控制
- **临时权限**: 支持权限有效期设置
- **权限申请**: 支持申请过期机制
- **角色权限**: 支持角色权限失效

## 💡 使用建议

### 1. 日常运维
- 定期检查临时权限是否到期
- 监控权限申请审批流程
- 定期分析权限使用统计

### 2. 权限管理
- 新用户入职：在用户组织关系表添加记录
- 调班调岗：更新组织关系，保留历史记录
- 权限扩展：通过ACL表精确控制资源权限

### 3. 系统扩展
- 新增资源类型：扩展权限定义表
- 新增组织：维护组织树维度表
- 新增角色：更新角色定义和权限桥接

## 🔧 维护指南

### 常用查询

```sql
-- 查看用户权限
SELECT u.真实姓名, p.权限名称, o.组织名称 
FROM 个人维度 u
JOIN 用户组织关系表 uo ON u.用户ID = uo.用户ID
JOIN 角色权限桥接表 rp ON uo.角色ID = rp.角色ID
JOIN 权限定义表 p ON rp.权限ID = p.权限ID
JOIN 组织树维度 o ON uo.组织ID = o.组织ID
WHERE u.用户ID = 'USER_ID';

-- 查看资源权限
SELECT acl.*, u.真实姓名 
FROM 题目操作ACL表 acl
JOIN 个人维度 u ON acl.创建者ID = u.用户ID
WHERE acl.资源ID = 'RESOURCE_ID';

-- 查看临时权限
SELECT u.真实姓名, o.组织名称, uo.失效时间
FROM 用户组织关系表 uo
JOIN 个人维度 u ON uo.用户ID = u.用户ID
JOIN 组织树维度 o ON uo.组织ID = o.组织ID
WHERE uo.关系类型 = '临时权限'
AND uo.失效时间 > NOW();
```

### 性能优化建议

1. **索引优化**: 已为所有查询路径建立索引
2. **分区表**: 考虑对审计表按时间分区
3. **缓存策略**: 用户权限可缓存，减少实时查询
4. **定期清理**: 定期清理过期的临时权限和审计日志

## 🎯 下一步计划

1. **业务模块集成**: 整合题库、考试、错题分析模块
2. **前端界面**: 开发权限管理界面
3. **API接口**: 提供标准权限检查API
4. **监控告警**: 实现权限异常监控
5. **数据可视化**: 权限使用情况可视化看板

---

## 📞 技术支持

- **数据库连接**: 10.10.0.117:6033/data_ware_test
- **脚本文件**: 
  - `create_permission_system.py` - 建表脚本
  - `insert_sample_data.py` - 数据插入
  - `test_permission_system.py` - 功能验证
- **配置文件**: `requirements.txt` - Python依赖

🎉 **恭喜！你的权限系统已经完全建立并验证成功！** 